<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kfz-Manager Pro V7.4</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary: #2980b9; --secondary: #2c3e50; --success: #27ae60;
      --warning: #f39c12; --danger: #e74c3c; --light: #f4f7f6;
      --card-bg: #ffffff; --text: #333333; --border: #dddddd;
    }
    @media (prefers-color-scheme: dark) {
      :root { --light: #1a1a1a; --card-bg: #2c2c2c; --text: #e0e0e0; --border: #444444; }
    }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--light); color: var(--text); line-height: 1.5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
    
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid var(--border); }
    .tab { padding: 12px 18px; cursor: pointer; border-radius: 8px 8px 0 0; background: var(--border); border: none; color: var(--text); font-weight: bold; }
    .tab.active { background: var(--primary); color: white; }

    .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid var(--border); }
    .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: end; }
    
    input, select, button { padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; background: var(--card-bg); color: var(--text); width: 100%; box-sizing: border-box; }
    button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
    button:hover { opacity: 0.9; }

    .filter-section { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; background: var(--secondary); padding: 15px; border-radius: 10px; color: white; }
    .filter-section select { width: auto; min-width: 250px; background: white; color: black; }

    .vehicle-container { border: 1px solid var(--border); border-radius: 10px; margin-bottom: 15px; overflow: hidden; background: var(--card-bg); }
    .vehicle-header { background: var(--secondary); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
    .header-overdue { background: var(--danger) !important; }
    .header-warning { background: var(--warning) !important; color: black !important; }

    .term-row { display: grid; grid-template-columns: 2fr 2fr 1fr 1fr 1fr; gap: 10px; padding: 10px 15px; border-bottom: 1px solid var(--border); align-items: center; }
    .term-row:last-child { border-bottom: none; }

    .status-ok { color: var(--success); font-weight: bold; }
    .status-warning { color: #d35400; font-weight: bold; }
    .status-overdue { color: var(--danger); font-weight: bold; }

    #notifStatus { padding: 6px 15px; border-radius: 20px; transition: all 0.3s; font-size: 0.85rem; background: var(--border); border: 1px solid #999; }
    #notifStatus.granted { background: var(--success); color: white; border-color: var(--success); }
    #notifStatus.denied { background: var(--danger); color: white; border-color: var(--danger); }

    .hidden { display: none; }
    .empty-state { text-align: center; padding: 40px; color: #888; border: 2px dashed var(--border); border-radius: 10px; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>üöõ Kfz-Manager Pro V7.4</h1>
    <div id="notifStatus" style="cursor: pointer;" onclick="requestNotifications()">üîî Alarm pr√ºfen...</div>
  </header>
  
  <div class="tabs">
    <button class="tab active" onclick="showTab('planer')">üìã Planer</button>
    <button class="tab" onclick="showTab('archive')">üìÇ Archiv</button>
    <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Optionen</button>
  </div>

  <div id="tab-planer">
    <div class="card">
      <div class="grid-form">
        <div><label>Fahrzeug-Stamm</label><input type="text" id="newVehicle" placeholder="Kennzeichen..." onkeyup="this.value = this.value.toUpperCase()"></div>
        <button onclick="addVehicle()">Registrieren</button>
        <div><label>Stamm-Verwaltung</label><select id="vehicleSelect" onchange="checkVehicleConflict()"></select></div>
        <button onclick="deleteVehicle()" style="background:var(--danger)">L√∂schen</button>
      </div>
      <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">
      <div class="grid-form">
        <div><label>F√§llig am</label><input type="date" id="dateInput"></div>
        <div><label>Pr√ºfung</label><select id="typeSelect"></select></div>
        <div><label>KM (optional)</label><input type="number" id="kmInput" placeholder="Stand"></div>
        <button onclick="addEntry()" style="background:var(--success)">Termin speichern</button>
      </div>
    </div>

    <div class="filter-section">
      <label><strong>Anzeige filtern:</strong></label>
      <select id="displayFilter" onchange="refreshTable()">
        <option value="none">-- Kein Fahrzeug ausgew√§hlt --</option>
        <option value="all">Alle Fahrzeuge anzeigen</option>
      </select>
      <button onclick="generatePDF()" style="width:auto; margin-left:auto; background:var(--primary)">üìÑ PDF Druck</button>
    </div>

    <div id="vehicleDisplayList"></div>
  </div>

  <div id="tab-archive" class="hidden">
    <div class="card">
      <h3>Abgeschlossene Pr√ºfungen</h3>
      <table style="width:100%; border-collapse: collapse;">
        <thead style="background: var(--primary); color: white;">
          <tr><th style="padding:10px;">Datum</th><th>Fahrzeug</th><th>Pr√ºfung</th><th>KM</th></tr>
        </thead>
        <tbody id="archiveBody"></tbody>
      </table>
    </div>
  </div>

  <div id="tab-settings" class="hidden">
    <div class="card">
      <h3>Datensicherung</h3>
      <div class="grid-form">
        <button onclick="exportData()" style="background:var(--secondary)">üíæ Backup exportieren</button>
        <button onclick="document.getElementById('importFile').click()" style="background:var(--primary)">üìÇ Backup importieren</button>
        <input type="file" id="importFile" onchange="importData()" class="hidden">
      </div>
    </div>
    
    <div class="card">
      <h3>Intervalle (Tage)</h3>
      <div id="intervalSettings" class="grid-form"></div>
      <button onclick="saveIntervals()" style="margin-top:15px; background:var(--success)">Intervalle speichern</button>
    </div>
  </div>
</div>

<script>
let data = JSON.parse(localStorage.getItem('v74_data') || '[]');
let vehicles = JSON.parse(localStorage.getItem('v74_vehicles') || '[]');
let archive = JSON.parse(localStorage.getItem('v74_archive') || '[]');
let intervals = JSON.parse(localStorage.getItem('v74_intervals') || JSON.stringify({
  'T√úV': 365, 'Eichamt': 730, 'Tachopr√ºfung': 730, 'Pr√ºfung Liege': 730, 'Rampe': 365
}));

function saveAll() {
  localStorage.setItem('v74_data', JSON.stringify(data));
  localStorage.setItem('v74_vehicles', JSON.stringify(vehicles));
  localStorage.setItem('v74_archive', JSON.stringify(archive));
  localStorage.setItem('v74_intervals', JSON.stringify(intervals));
}

function updateNotifVisuals() {
  const el = document.getElementById('notifStatus');
  if (Notification.permission === 'granted') {
    el.innerText = '‚úÖ Alarm Aktiv';
    el.className = 'granted';
  } else if (Notification.permission === 'denied') {
    el.innerText = '‚ö†Ô∏è Blockiert (Anleitung?)';
    el.className = 'denied';
  } else {
    el.innerText = 'üîî Alarm aktivieren';
    el.className = '';
  }
}

function requestNotifications() {
  if (Notification.permission === 'denied') {
    alert("Benachrichtigungen wurden blockiert.\n\nSo entsperren Sie sie:\n1. Klicken Sie auf das Schloss-Symbol neben der URL.\n2. Setzen Sie 'Benachrichtigungen' auf 'Zulassen'.\n3. Seite neu laden!");
    return;
  }
  Notification.requestPermission().then(updateNotifVisuals);
}

function showTab(tabId) {
  document.querySelectorAll('[id^="tab-"]').forEach(t => t.classList.add('hidden'));
  document.getElementById('tab-' + tabId).classList.remove('hidden');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.currentTarget.classList.add('active');
  if(tabId === 'archive') refreshArchive();
  if(tabId === 'settings') renderIntervalSettings();
}

function refreshVehicleSelect() {
  const sel = document.getElementById('vehicleSelect');
  const dFilter = document.getElementById('displayFilter');
  const oldVal = dFilter.value;
  sel.innerHTML = '<option value="">-- Fahrzeug w√§hlen --</option>';
  dFilter.innerHTML = '<option value="none">-- Ausw√§hlen --</option><option value="all">Alle anzeigen</option>';
  vehicles.sort().forEach(v => {
    const opt = `<option value="${v}">${v}</option>`;
    sel.innerHTML += opt;
    dFilter.innerHTML += opt;
  });
  dFilter.value = vehicles.includes(oldVal) || oldVal === 'all' ? oldVal : 'none';
  const tSel = document.getElementById('typeSelect');
  tSel.innerHTML = '';
  Object.keys(intervals).forEach(k => { tSel.innerHTML += `<option value="${k}">${k}</option>`; });
}

function checkVehicleConflict() {
  const v = document.getElementById('vehicleSelect').value;
  if (v && data.some(d => d.vehicle === v)) {
    if (!confirm(`Fahrzeug ${v} ist bereits in Liste. Neuen Termin hinzuf√ºgen?`)) document.getElementById('vehicleSelect').value = "";
  }
}

function addVehicle() {
  const v = document.getElementById('newVehicle').value.trim();
  if(v && !vehicles.includes(v)) {
    vehicles.push(v); saveAll(); refreshVehicleSelect();
    document.getElementById('newVehicle').value = '';
    document.getElementById('vehicleSelect').value = v;
  }
}

function addEntry() {
  const v = document.getElementById('vehicleSelect').value;
  const d = document.getElementById('dateInput').value;
  if(!v || !d) return alert("Fahrzeug/Datum fehlen!");
  data.push({ id: Date.now(), vehicle: v, date: d, type: document.getElementById('typeSelect').value, km: document.getElementById('kmInput').value });
  saveAll();
  document.getElementById('dateInput').value = '';
  document.getElementById('kmInput').value = '';
  document.getElementById('vehicleSelect').value = "";
  refreshTable();
}

function refreshTable() {
  const display = document.getElementById('vehicleDisplayList');
  const filterVal = document.getElementById('displayFilter').value;
  display.innerHTML = '';
  if (filterVal === 'none') { display.innerHTML = '<div class="empty-state">Bitte Fahrzeug ausw√§hlen.</div>'; return; }
  const activeVehicles = (filterVal === 'all') ? [...new Set(data.map(d => d.vehicle))].sort() : [filterVal];
  activeVehicles.forEach(vName => {
    const vEntries = data.filter(d => d.vehicle === vName);
    if (vEntries.length === 0) return;
    let maxU = 0; let rows = '';
    vEntries.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(e => {
      const diff = Math.ceil((new Date(e.date) - new Date().setHours(0,0,0,0)) / 86400000);
      let c = 'status-ok', t = 'üìÖ OK';
      if(diff < 0) { c = 'status-overdue'; t = '‚ùå F√ÑLLIG'; maxU = 2; }
      else if(diff <= 14) { c = 'status-warning'; t = '‚ö†Ô∏è BALD'; if(maxU < 2) maxU = 1; }
      rows += `<div class="term-row"><div><strong>${e.type}</strong></div><div onclick="edit(${e.id},'date',this)">${new Date(e.date).toLocaleDateString()}</div><div>${e.km || '-'}</div><div class="${c}">${t}</div><div style="text-align:right;"><button onclick="completeEntry(${e.id})" style="width:auto; background:var(--success); padding:2px 8px;">‚úÖ</button></div></div>`;
    });
    const hC = (maxU === 2) ? 'header-overdue' : (maxU === 1 ? 'header-warning' : '');
    const div = document.createElement('div'); div.className = 'vehicle-container';
    div.innerHTML = `<div class="vehicle-header ${hC}"><span>üöó <strong>${vName}</strong></span></div>${rows}`;
    display.appendChild(div);
  });
}

function completeEntry(id) {
  const idx = data.findIndex(d => d.id === id);
  const old = data[idx];
  archive.push({ ...old, completedDate: new Date().toISOString().split('T')[0] });
  const next = new Date(old.date);
  next.setDate(next.getDate() + (intervals[old.type] || 365));
  old.date = next.toISOString().split('T')[0];
  old.km = ''; saveAll(); refreshTable();
}

function exportData() {
  const b = { data, vehicles, archive, intervals };
  const blob = new Blob([JSON.stringify(b, null, 2)], {type: 'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `fuhrpark_v74_${new Date().toISOString().split('T')[0]}.json`; a.click();
}

function importData() {
  const file = document.getElementById('importFile').files[0];
  const reader = new FileReader();
  reader.onload = (e) => {
    const j = JSON.parse(e.target.result);
    if(confirm("Daten √ºberschreiben?")) {
      data = j.data; vehicles = j.vehicles; archive = j.archive || []; intervals = j.intervals || intervals;
      saveAll(); location.reload();
    }
  };
  reader.readAsText(file);
}

function renderIntervalSettings() {
  const div = document.getElementById('intervalSettings');
  div.innerHTML = '';
  Object.keys(intervals).forEach(k => {
    div.innerHTML += `<div><label>${k}</label><input type="number" value="${intervals[k]}" data-key="${k}" class="int-v"></div>`;
  });
}

function saveIntervals() {
  document.querySelectorAll('.int-v').forEach(i => intervals[i.dataset.key] = parseInt(i.value));
  saveAll(); alert("Gespeichert!");
}

function refreshArchive() {
  const b = document.getElementById('archiveBody'); b.innerHTML = '';
  archive.slice().reverse().forEach(e => {
    b.innerHTML += `<tr style="border-bottom: 1px solid var(--border);"><td style="padding:8px;">${e.completedDate}</td><td>${e.vehicle}</td><td>${e.type}</td><td>${e.km || '-'}</td></tr>`;
  });
}

function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Fuhrpark Pr√ºfplan - Statusbericht", 14, 15);
  const rows = data.map(e => [e.vehicle, e.type, e.date, e.km || '-']);
  doc.autoTable({ head: [['Fahrzeug', 'Pr√ºfung', 'F√§llig am', 'KM']], body: rows, startY: 20 });
  doc.save("Pruefplan.pdf");
}

updateNotifVisuals();
refreshVehicleSelect();
refreshTable();
</script>
</body>
</html>
